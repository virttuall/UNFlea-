Event.simulateMouse=function(e,t){var n=Object.extend({pointerX:0,pointerY:0,buttons:0,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false},arguments[2]||{});var r=document.createEvent("MouseEvents");r.initMouseEvent(t,true,true,document.defaultView,n.buttons,n.pointerX,n.pointerY,n.pointerX,n.pointerY,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,0,$(e));if(this.mark)Element.remove(this.mark);this.mark=document.createElement("div");this.mark.appendChild(document.createTextNode(" "));document.body.appendChild(this.mark);this.mark.style.position="absolute";this.mark.style.top=n.pointerY+"px";this.mark.style.left=n.pointerX+"px";this.mark.style.width="5px";this.mark.style.height="5px;";this.mark.style.borderTop="1px solid red;";this.mark.style.borderLeft="1px solid red;";if(this.step)alert("["+(new Date).getTime().toString()+"] "+t+"/"+Test.Unit.inspect(n));$(e).dispatchEvent(r)};Event.simulateKey=function(e,t){var n=Object.extend({ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,keyCode:0,charCode:0},arguments[2]||{});var r=document.createEvent("KeyEvents");r.initKeyEvent(t,true,true,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);$(e).dispatchEvent(r)};Event.simulateKeys=function(e,t){for(var n=0;n<t.length;n++){Event.simulateKey(e,"keypress",{charCode:t.charCodeAt(n)})}};var Test={};Test.Unit={};Test.Unit.inspect=Object.inspect;Test.Unit.Logger=Class.create();Test.Unit.Logger.prototype={initialize:function(e){this.log=$(e);if(this.log){this._createLogTable()}},start:function(e){if(!this.log)return;this.testName=e;this.lastLogLine=document.createElement("tr");this.statusCell=document.createElement("td");this.nameCell=document.createElement("td");this.nameCell.className="nameCell";this.nameCell.appendChild(document.createTextNode(e));this.messageCell=document.createElement("td");this.lastLogLine.appendChild(this.statusCell);this.lastLogLine.appendChild(this.nameCell);this.lastLogLine.appendChild(this.messageCell);this.loglines.appendChild(this.lastLogLine)},finish:function(e,t){if(!this.log)return;this.lastLogLine.className=e;this.statusCell.innerHTML=e;this.messageCell.innerHTML=this._toHTML(t);this.addLinksToResults()},message:function(e){if(!this.log)return;this.messageCell.innerHTML=this._toHTML(e)},summary:function(e){if(!this.log)return;this.logsummary.innerHTML=this._toHTML(e)},_createLogTable:function(){this.log.innerHTML='<div id="logsummary"></div>'+'<table id="logtable">'+"<thead><tr><th>Status</th><th>Test</th><th>Message</th></tr></thead>"+'<tbody id="loglines"></tbody>'+"</table>";this.logsummary=$("logsummary");this.loglines=$("loglines")},_toHTML:function(e){return e.escapeHTML().replace(/\n/g,"<br/>")},addLinksToResults:function(){$$("tr.failed .nameCell").each(function(e){e.title="Run only this test";Event.observe(e,"click",function(){window.location.search="?tests="+e.innerHTML})});$$("tr.passed .nameCell").each(function(e){e.title="Run all tests";Event.observe(e,"click",function(){window.location.search=""})})}};Test.Unit.Runner=Class.create();Test.Unit.Runner.prototype={initialize:function(e){this.options=Object.extend({testLog:"testlog"},arguments[1]||{});this.options.resultsURL=this.parseResultsURLQueryParameter();this.options.tests=this.parseTestsQueryParameter();if(this.options.testLog){this.options.testLog=$(this.options.testLog)||null}if(this.options.tests){this.tests=[];for(var t=0;t<this.options.tests.length;t++){if(/^test/.test(this.options.tests[t])){this.tests.push(new Test.Unit.Testcase(this.options.tests[t],e[this.options.tests[t]],e["setup"],e["teardown"]))}}}else{if(this.options.test){this.tests=[new Test.Unit.Testcase(this.options.test,e[this.options.test],e["setup"],e["teardown"])]}else{this.tests=[];for(var n in e){if(/^test/.test(n)){this.tests.push(new Test.Unit.Testcase(this.options.context?" -> "+this.options.titles[n]:n,e[n],e["setup"],e["teardown"]))}}}}this.currentTest=0;this.logger=new Test.Unit.Logger(this.options.testLog);setTimeout(this.runTests.bind(this),1e3)},parseResultsURLQueryParameter:function(){return window.location.search.parseQuery()["resultsURL"]},parseTestsQueryParameter:function(){if(window.location.search.parseQuery()["tests"]){return window.location.search.parseQuery()["tests"].split(",")}},getResult:function(){var e=false;for(var t=0;t<this.tests.length;t++){if(this.tests[t].errors>0){return"ERROR"}if(this.tests[t].failures>0){e=true}}if(e){return"FAILURE"}else{return"SUCCESS"}},postResults:function(){if(this.options.resultsURL){new Ajax.Request(this.options.resultsURL,{method:"get",parameters:"result="+this.getResult(),asynchronous:false})}},runTests:function(){var e=this.tests[this.currentTest];if(!e){this.postResults();this.logger.summary(this.summary());return}if(!e.isWaiting){this.logger.start(e.name)}e.run();if(e.isWaiting){this.logger.message("Waiting for "+e.timeToWait+"ms");setTimeout(this.runTests.bind(this),e.timeToWait||1e3)}else{this.logger.finish(e.status(),e.summary());this.currentTest++;this.runTests()}},summary:function(){var e=0;var t=0;var n=0;var r=[];for(var i=0;i<this.tests.length;i++){e+=this.tests[i].assertions;t+=this.tests[i].failures;n+=this.tests[i].errors}return(this.options.context?this.options.context+": ":"")+this.tests.length+" tests, "+e+" assertions, "+t+" failures, "+n+" errors"}};Test.Unit.Assertions=Class.create();Test.Unit.Assertions.prototype={initialize:function(){this.assertions=0;this.failures=0;this.errors=0;this.messages=[]},summary:function(){return this.assertions+" assertions, "+this.failures+" failures, "+this.errors+" errors"+"\n"+this.messages.join("\n")},pass:function(){this.assertions++},fail:function(e){this.failures++;this.messages.push("Failure: "+e)},info:function(e){this.messages.push("Info: "+e)},error:function(e){this.errors++;this.messages.push(e.name+": "+e.message+"("+Test.Unit.inspect(e)+")")},status:function(){if(this.failures>0)return"failed";if(this.errors>0)return"error";return"passed"},assert:function(e){var t=arguments[1]||'assert: got "'+Test.Unit.inspect(e)+'"';try{e?this.pass():this.fail(t)}catch(n){this.error(n)}},assertEqual:function(e,t){var n=arguments[2]||"assertEqual";try{e==t?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertInspect:function(e,t){var n=arguments[2]||"assertInspect";try{e==t.inspect()?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertEnumEqual:function(e,t){var n=arguments[2]||"assertEnumEqual";try{$A(e).length==$A(t).length&&e.zip(t).all(function(e){return e[0]==e[1]})?this.pass():this.fail(n+": expected "+Test.Unit.inspect(e)+", actual "+Test.Unit.inspect(t))}catch(r){this.error(r)}},assertNotEqual:function(e,t){var n=arguments[2]||"assertNotEqual";try{e!=t?this.pass():this.fail(n+': got "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertIdentical:function(e,t){var n=arguments[2]||"assertIdentical";try{e===t?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertNotIdentical:function(e,t){var n=arguments[2]||"assertNotIdentical";try{!(e===t)?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+Test.Unit.inspect(t)+'"')}catch(r){this.error(r)}},assertNull:function(e){var t=arguments[1]||"assertNull";try{e==null?this.pass():this.fail(t+': got "'+Test.Unit.inspect(e)+'"')}catch(n){this.error(n)}},assertMatch:function(e,t){var n=arguments[2]||"assertMatch";var r=new RegExp(e);try{r.exec(t)?this.pass():this.fail(n+' : regex: "'+Test.Unit.inspect(e)+" did not match: "+Test.Unit.inspect(t)+'"')}catch(i){this.error(i)}},assertHidden:function(e){var t=arguments[1]||"assertHidden";this.assertEqual("none",e.style.display,t)},assertNotNull:function(e){var t=arguments[1]||"assertNotNull";this.assert(e!=null,t)},assertType:function(e,t){var n=arguments[2]||"assertType";try{t.constructor==e?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+t.constructor+'"')}catch(r){this.error(r)}},assertNotOfType:function(e,t){var n=arguments[2]||"assertNotOfType";try{t.constructor!=e?this.pass():this.fail(n+': expected "'+Test.Unit.inspect(e)+'", actual "'+t.constructor+'"')}catch(r){this.error(r)}},assertInstanceOf:function(e,t){var n=arguments[2]||"assertInstanceOf";try{t instanceof e?this.pass():this.fail(n+": object was not an instance of the expected type")}catch(r){this.error(r)}},assertNotInstanceOf:function(e,t){var n=arguments[2]||"assertNotInstanceOf";try{!(t instanceof e)?this.pass():this.fail(n+": object was an instance of the not expected type")}catch(r){this.error(r)}},assertRespondsTo:function(e,t){var n=arguments[2]||"assertRespondsTo";try{t[e]&&typeof t[e]=="function"?this.pass():this.fail(n+": object doesn't respond to ["+e+"]")}catch(r){this.error(r)}},assertReturnsTrue:function(e,t){var n=arguments[2]||"assertReturnsTrue";try{var r=t[e];if(!r)r=t["is"+e.charAt(0).toUpperCase()+e.slice(1)];r()?this.pass():this.fail(n+": method returned false")}catch(i){this.error(i)}},assertReturnsFalse:function(e,t){var n=arguments[2]||"assertReturnsFalse";try{var r=t[e];if(!r)r=t["is"+e.charAt(0).toUpperCase()+e.slice(1)];!r()?this.pass():this.fail(n+": method returned true")}catch(i){this.error(i)}},assertRaise:function(e,t){var n=arguments[2]||"assertRaise";try{t();this.fail(n+": exception expected but none was raised")}catch(r){e==null||r.name==e?this.pass():this.error(r)}},assertElementsMatch:function(){var e=$A(arguments),t=$A(e.shift());if(t.length!=e.length){this.fail("assertElementsMatch: size mismatch: "+t.length+" elements, "+e.length+" expressions");return false}t.zip(e).all(function(e,t){var n=$(e.first()),r=e.last();if(n.match(r))return true;this.fail("assertElementsMatch: (in index "+t+") expected "+r.inspect()+" but got "+n.inspect())}.bind(this))&&this.pass()},assertElementMatches:function(e,t){this.assertElementsMatch([e],t)},benchmark:function(e,t){var n=new Date;(t||1).times(e);var r=new Date-n;this.info((arguments[2]||"Operation")+" finished "+t+" iterations in "+r/1e3+"s");return r},_isVisible:function(e){e=$(e);if(!e.parentNode)return true;this.assertNotNull(e);if(e.style&&Element.getStyle(e,"display")=="none")return false;return this._isVisible(e.parentNode)},assertNotVisible:function(e){this.assert(!this._isVisible(e),Test.Unit.inspect(e)+" was not hidden and didn't have a hidden parent either. "+(""||arguments[1]))},assertVisible:function(e){this.assert(this._isVisible(e),Test.Unit.inspect(e)+" was not visible. "+(""||arguments[1]))},benchmark:function(e,t){var n=new Date;(t||1).times(e);var r=new Date-n;this.info((arguments[2]||"Operation")+" finished "+t+" iterations in "+r/1e3+"s");return r}};Test.Unit.Testcase=Class.create();Object.extend(Object.extend(Test.Unit.Testcase.prototype,Test.Unit.Assertions.prototype),{initialize:function(name,test,setup,teardown){Test.Unit.Assertions.prototype.initialize.bind(this)();this.name=name;if(typeof test=="string"){test=test.gsub(/(\.should[^\(]+\()/,"#{0}this,");test=test.gsub(/(\.should[^\(]+)\(this,\)/,"#{1}(this)");this.test=function(){eval("with(this){"+test+"}")}}else{this.test=test||function(){}}this.setup=setup||function(){};this.teardown=teardown||function(){};this.isWaiting=false;this.timeToWait=1e3},wait:function(e,t){this.isWaiting=true;this.test=t;this.timeToWait=e},run:function(){try{try{if(!this.isWaiting)this.setup.bind(this)();this.isWaiting=false;this.test.bind(this)()}finally{if(!this.isWaiting){this.teardown.bind(this)()}}}catch(e){this.error(e)}}});Test.setupBDDExtensionMethods=function(){var e={shouldEqual:"assertEqual",shouldNotEqual:"assertNotEqual",shouldEqualEnum:"assertEnumEqual",shouldBeA:"assertType",shouldNotBeA:"assertNotOfType",shouldBeAn:"assertType",shouldNotBeAn:"assertNotOfType",shouldBeNull:"assertNull",shouldNotBeNull:"assertNotNull",shouldBe:"assertReturnsTrue",shouldNotBe:"assertReturnsFalse",shouldRespondTo:"assertRespondsTo"};var t=function(e,t,n){this[e].apply(this,(t||[]).concat([n]))};Test.BDDMethods={};$H(e).each(function(e){Test.BDDMethods[e.key]=function(){var n=$A(arguments);var r=n.shift();t.apply(r,[e.value,n,this])}});[Array.prototype,String.prototype,Number.prototype,Boolean.prototype].each(function(e){Object.extend(e,Test.BDDMethods)})};Test.context=function(e,t,n){Test.setupBDDExtensionMethods();var r={};var i={};for(specName in t){switch(specName){case"setup":case"teardown":r[specName]=t[specName];break;default:var s="test"+specName.gsub(/\s+/,"-").camelize();var o=t[specName].toString().split("\n").slice(1);if(/^\{/.test(o[0]))o=o.slice(1);o.pop();o=o.map(function(e){return e.strip()});r[s]=o.join("\n");i[s]=specName}}new Test.Unit.Runner(r,{titles:i,testLog:n||"testlog",context:e})}